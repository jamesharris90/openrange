# Copilot Instructions

- **System overview**: Static HTML + vanilla JS in root/js served by Express proxy in [server/index.js](server/index.js). Backend fronts Saxo OpenAPI (/api/saxo/*), Finviz exports (/api/finviz/*), Finnhub news (/api/news), AI Quant proxy to Perplexity (/api/ai-quant/*), and SEC/scanner context helpers.
- **Backend entrypoint**: Start from [server/index.js](server/index.js); it wires CORS/security headers, rate limiting, static hosting, Saxo OAuth, Finviz/Finnhub proxies, AI Quant, and user management routes.
- **Run locally**: `cd server && npm install && npm start` (or `npm run dev` with nodemon). Detached helpers live in [server/scripts](server/scripts). Logs go to [server/logs](server/logs) via winston config in [server/logger.js](server/logger.js).
- **Environment**: Use `.env` in server root. Important keys: `SAXO_APP_KEY/SAXO_APP_SECRET/SAXO_AUTH_URL/SAXO_TOKEN_URL/SAXO_REDIRECT_URI` (OAuth), `SAXO_CLIENT_KEY/SAXO_ACCOUNT_NUMBER` (exposed to frontend), `PROXY_API_KEY` (x-api-key fallback when no JWT), `JWT_SECRET`, `ENCRYPTION_KEY` (AES for stored secrets), `FINVIZ_NEWS_TOKEN` (required for Finviz exports), `FINNHUB_API_KEY` (news proxy), `PPLX_API_KEY`/`PPLX_MODEL` (AI Quant), optional `ALLOWED_ORIGINS` and `NODE_ENV=production` to tighten CSP.
- **Saxo OAuth flow**: Implemented in [server/saxo-oauth.js](server/saxo-oauth.js). /auth/saxo/login redirects to Saxo, /auth/callback stores tokens to `server/saxo-tokens.json` and auto-refreshes 5 minutes before expiry. `/api/saxo/auth/status` reports auth state; `/api/saxo/auth/disconnect` clears.
- **User system**: SQLite stored at [server/users/users.db](server/users/users.db). Model in [server/users/model.js](server/users/model.js) handles registration/login, JWT payload, admin flags, Saxo token encryption, Perplexity prefs, activity log, and settings table. Routes in [server/users/routes.js](server/users/routes.js) enforce validation, admin guards, and log activities.
- **Auth rules**: Public paths include Finviz/Finnhub/news snippet endpoints. Everything else requires valid JWT or matching `x-api-key` (`PROXY_API_KEY`). Rate limits: 5 registrations per 15m; general 120 req/min.
- **AI Quant**: `/api/ai-quant/query` builds a trading-focused prompt, optionally injecting scanner or SEC context (`contextSource` param) via helpers in [server/index.js](server/index.js). Uses Perplexity chat completions; users can override API key/model via `/api/users/pplx/settings`.
- **Finviz/Finnhub**: Finviz CSV exports normalized/cached in `/api/finviz/news` and `/api/finviz/screener`; quote scraper parses HTML snapshot fields. Finnhub `/api/news` caches 5 minutes. Missing `FINVIZ_NEWS_TOKEN` disables these endpoints gracefully.
- **Database migrations**: Managed by [server/users/migrations.js](server/users/migrations.js) with SQL files in [server/users/migrations](server/users/migrations). Commands: `cd server/users && node migrations.js status|migrate|rollback`. Rollback only deletes the record; author down-migration manually if needed.
- **Frontend config**: [js/config.js](js/config.js) sets `CONFIG.API_BASE` (localhost vs origin) and pulls `/api/config` to populate Saxo keys. Keep API calls using this base and the `/api/saxo` proxy path.
- **Frontend auth pattern**: [js/auth.js](js/auth.js) stores JWT in localStorage, exposes `AUTH.protect()` for gated pages, and adds JWT + optional `window.API_KEY` headers for proxy calls. Do not log out on Saxo 401; it only means Saxo not connected.
- **Frontend utilities**: [js/utils.js](js/utils.js) holds SymbolSearch autocomplete (Finviz-backed cache) and ORB rules renderer. Reuse helpers instead of duplicating ticker lookup UI.
- **Testing**: Run `cd server && npm test`. Jest tests cover user route validation and sample validators ([server/tests](server/tests)).
- **Data directories**: SEC/earnings context read from [server/data](server/data) files if present; ensure JSON/MD shape matches consumers in [server/index.js](server/index.js).
- **Security defaults**: Content-Security-Policy applies when `NODE_ENV=production`; adjust if adding external widgets. Cookies for OAuth state are httpOnly. Do not expose `.env` or `saxo-tokens.json`.
- **Adding endpoints**: Keep proxies behind JWT or API-key middleware unless explicitly public; log requests via existing middleware and return JSON errors with `detail` when upstream fails.

If anything here feels off or incomplete, tell me what to refine and I will update this guide.
