<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Scanner - OpenRange Trader</title>
    <script>
        // Redirect legacy static page to the React SPA route
        window.location.replace('/app/news-scanner');
    </script>
    <link rel="stylesheet" href="/styles.css">
    <link rel="icon" type="image/x-icon" href="/logo pack/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="/js/sidebar.js"></script>

    <script>window.API_KEY = 'openrange-test-key-secure-2026';</script>

    <script src="/js/auth.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/watchlist-store.js"></script>
    <script src="/js/filtering/filter-framework.js"></script>
    <script src="/config/filterConfig.js"></script>
    <script src="/js/filtering/filter-configs.js"></script>
    <script src="/js/news-scanner.js"></script>

    <style>
        .catalyst-earnings { background: #4f46e5; color: white; }
        .catalyst-fda { background: #10b981; color: white; }
        .catalyst-product { background: #f59e0b; color: white; }
        .catalyst-merger { background: #8b5cf6; color: white; }
        .catalyst-contract { background: #06b6d4; color: white; }
        .catalyst-upgrade { background: #ec4899; color: white; }
        .catalyst-offering { background: #f97316; color: white; }
        .catalyst-guidance { background: #6366f1; color: white; }
        .catalyst-general { background: var(--bg-secondary); color: var(--text-secondary); }

        .news-source { color: var(--text-secondary); font-size: 0.85em; font-weight: 500; }
        .news-time { color: var(--text-muted); font-size: 0.8em; }
        .news-title { font-size: 1.05em; line-height: 1.5; }
        .news-title a { color: var(--text-primary); text-decoration: none; font-weight: 500; }
        .news-title a:hover { color: var(--accent-blue); }

        .no-data, .screener-error { padding: 60px; text-align: center; color: var(--text-muted); }
        .screener-error { display: flex; flex-direction: column; align-items: center; gap: 16px; }
        .screener-error button { padding: 10px 24px; background: var(--accent-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }

        .news-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); z-index: 10000; backdrop-filter: blur(4px); }
        .news-modal.active { display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s ease; }
        .news-modal-content { width: 90vw; height: 90vh; background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; animation: slideUp 0.3s ease; }
        .news-modal-header { padding: 20px 24px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 16px; }
        .news-modal-title { font-size: 1.1em; font-weight: 600; color: var(--text-primary); flex: 1; }
        .news-modal-close { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .news-modal-close:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .news-modal-iframe { flex: 1; border: none; background: white; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 1200px) {
            .stock-filters { grid-template-columns: repeat(2, 1fr); }
            .news-scanner-item { flex-direction: column; gap: 12px; }
            .news-modal-content { width: 95vw; height: 95vh; }
        }

        /* News Scanner layout tweaks */
        .filter-sections.layout-horizontal {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-sections.layout-horizontal .filter-section {
            min-width: 300px;
            flex: 1;
        }

        .scoring-section .scoring-panel {
            background: transparent;
            box-shadow: none;
            padding: 0;
        }

        .scoring-body .score-row { justify-content: space-between; }

        #filter-wrapper { display: none; }

        .filter-toggle-btn { margin-left: 8px; }
    </style>
</head>
<body>
    <div class="user-header" style="position:fixed;right:0;top:0;z-index:1000;background:var(--bg-card);padding:8px 24px;min-width:220px;text-align:right;">
        <span id="userMenuName">Guest</span>
        <a href="login.html" id="loginLink">Login</a>
        <a href="register.html" id="registerLink">Register</a>
        <a href="user.html" id="profileLink" style="display:none;">Profile</a>
        <a href="admin.html" id="adminLink" style="display:none;">Admin</a>
        <a href="#" id="logoutLink" style="display:none;">Logout</a>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('authToken');
        const userMenuName = document.getElementById('userMenuName');
        const loginLink = document.getElementById('loginLink');
        const registerLink = document.getElementById('registerLink');
        const profileLink = document.getElementById('profileLink');
        const adminLink = document.getElementById('adminLink');
        const logoutLink = document.getElementById('logoutLink');
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                userMenuName.textContent = payload.username || 'User';
                loginLink.style.display = 'none';
                registerLink.style.display = 'none';
                profileLink.style.display = '';
                logoutLink.style.display = '';
                if (payload.is_admin) adminLink.style.display = '';
            } catch (e) {}
        } else {
            profileLink.style.display = 'none';
            adminLink.style.display = 'none';
            logoutLink.style.display = 'none';
        }
        logoutLink && logoutLink.addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
        });
    });
    </script>

    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <img src="logo pack/openrange_icon.png" alt="OpenRange Trader">
                    </div>
                    <div class="logo-text">
                        <div class="brand-name">
                            <span class="open">Open</span><span class="range">Range</span>
                        </div>
                        <div class="brand-tagline">TRADER</div>
                    </div>
                </a>
            </div>

            <nav class="nav-section">
                <div class="nav-label">Main</div>
                <a href="index.html" class="nav-link">
                    <i data-lucide="bar-chart-2" class="icon"></i>
                    <span class="label">Dashboard</span>
                </a>
                <a href="screeners.html" class="nav-link">
                    <i data-lucide="search" class="icon"></i>
                    <span class="label">Screeners</span>
                </a>
                <a href="watchlist.html" class="nav-link">
                    <i data-lucide="star" class="icon"></i>
                    <span class="label">Watchlist</span>
                </a>

                <div class="nav-label" style="margin-top: 24px;">Market Sessions</div>
                <a href="premarket.html" class="nav-link">
                    <i data-lucide="sunrise" class="icon"></i>
                    <span class="label">Pre-Market</span>
                </a>
                <a href="market-hours.html" class="nav-link">
                    <i data-lucide="trending-up" class="icon"></i>
                    <span class="label">Market Hours</span>
                </a>
                <a href="postmarket.html" class="nav-link">
                    <i data-lucide="sunset" class="icon"></i>
                    <span class="label">Post-Market</span>
                </a>

                <div class="nav-label" style="margin-top: 24px;">Tools</div>
                <a href="advanced-screener.html" class="nav-link">
                    <i data-lucide="filter" class="icon"></i>
                    <span class="label">Advanced Screener</span>
                </a>
                <a href="news-scanner.html" class="nav-link active">
                    <i data-lucide="newspaper" class="icon"></i>
                    <span class="label">News Scanner</span>
                </a>
                <a href="research.html" class="nav-link">
                    <i data-lucide="microscope" class="icon"></i>
                    <span class="label">Research</span>
                </a>
                <a href="ai-chat.html" class="nav-link">
                    <i data-lucide="bot" class="icon"></i>
                    <span class="label">AI Chat</span>
                </a>
                <a href="market-overview.html" class="nav-link">
                    <i data-lucide="globe" class="icon"></i>
                    <span class="label">Market Overview</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <h1 class="page-title">News Scanner</h1>
                <div class="top-bar-actions">
                    <button class="btn-primary" onclick="newsScanner.fetchNews()" style="margin-right: 12px;">
                        <i data-lucide="refresh-cw" style="width: 16px; height: 16px; margin-right: 6px;"></i>
                        Refresh Feed
                    </button>
                    <button id="toggle-filters" class="btn ghost filter-toggle-btn">Show Filters</button>
                    <div class="market-status">
                        <div class="status-dot"></div>
                        <span class="status-text" id="marketStatus">Market Status</span>
                    </div>
                </div>
            </div>

            <div class="content-container content-constrained">
                <div class="card">
                    <div class="card-body">
                        <p style="color: var(--text-secondary); margin: 0;">
                            Catalyst-focused news feed with unified filters, scoring, and ticker-level controls. Apply filters below to refresh results and export as CSV or text.
                        </p>
                    </div>
                </div>

                <div class="universal-filter-shell">
                    <div class="universal-filter-header">
                        <button class="filter-toggle-btn" id="universalFilterToggle">Show Filters â–¾</button>
                    </div>
                    <div class="universal-filter-body collapsed" id="universalFilterBody">
                        <div id="unified-filter-panel" class="filter-panel"></div>
                    </div>
                </div>
                <div class="filter-actions" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;">
                    <button class="btn-clear-filters" style="background:#f87171;color:white;padding:8px 18px;border:none;border-radius:6px;font-weight:600;cursor:pointer;" onclick="newsScanner.clearFilters()">
                        <i data-lucide="x-circle" style="width:16px;height:16px;margin-right:6px;vertical-align:middle;"></i>
                        Clear Filters
                    </button>
                    <div style="display:flex;gap:8px;">
                        <button class="btn-filter-action apply" onclick="newsScanner.exportResults('csv')">
                            Export CSV
                        </button>
                        <button class="btn-filter-action" onclick="newsScanner.exportResults('text')">
                            Export Text
                        </button>
                    </div>
                </div>

                <div id="news-filter-summary" style="display:none;margin-bottom:10px;font-size:1em;font-weight:500;color:var(--accent-blue);"></div>
                <div id="news-scanner-content">
                    <div class="loading" style="padding: 60px; text-align: center; color: var(--text-muted);">
                        Loading catalyst news...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        lucide.createIcons();

        document.addEventListener('DOMContentLoaded', async function() {
            if (window.configReady) {
                await window.configReady;
            }
            initUnifiedNewsFilters();
            newsScanner.fetchNews();
            setTimeout(() => { lucide.createIcons(); }, 300);

            const filterWrapper = document.getElementById('filter-wrapper');
            const toggleBtn = document.getElementById('toggle-filters');
            if (toggleBtn && filterWrapper) {
                const toggle = () => {
                    const isHidden = filterWrapper.style.display === 'none' || filterWrapper.style.display === '';
                    filterWrapper.style.display = isHidden ? 'block' : 'none';
                    toggleBtn.textContent = isHidden ? 'Hide Filters' : 'Show Filters';
                };
                toggleBtn.addEventListener('click', toggle);
                // Initialize hidden
                filterWrapper.style.display = 'none';
                toggleBtn.textContent = 'Show Filters';
            }
        });
    </script>

    <div id="newsModal" class="news-modal">
        <div class="news-modal-content">
            <div class="news-modal-header">
                <div class="news-modal-title" id="newsModalTitle">Loading...</div>
                <button class="news-modal-close" onclick="closeNewsModal()" title="Close (ESC)">
                    <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                </button>
            </div>
            <div class="news-modal-status">
                <span id="newsModalStatus">Loading article...</span>
                <a id="newsModalFallback" class="news-modal-link" href="#" target="_blank" rel="noopener noreferrer" style="display:none;">Open original</a>
            </div>
            <iframe id="newsModalIframe" class="news-modal-iframe"></iframe>
        </div>
    </div>

    <script>
        function openNewsModal(url, title) {
            const modal = document.getElementById('newsModal');
            const iframe = document.getElementById('newsModalIframe');
            const titleEl = document.getElementById('newsModalTitle');
            const statusEl = document.getElementById('newsModalStatus');
            const fallbackEl = document.getElementById('newsModalFallback');
            titleEl.textContent = title || 'Article';
            statusEl.textContent = 'Loading article...';
            fallbackEl.style.display = 'none';
            fallbackEl.href = url;
            iframe.src = url;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            if (window.lucide) { lucide.createIcons(); }

            // Show a fallback link if the frame stays blank due to X-Frame-Options
            setTimeout(() => {
                statusEl.textContent = 'If the article is blank, open in a new tab.';
                fallbackEl.style.display = 'inline-flex';
            }, 2000);
        }

        function closeNewsModal() {
            const modal = document.getElementById('newsModal');
            const iframe = document.getElementById('newsModalIframe');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            setTimeout(() => { iframe.src = ''; }, 300);
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') { closeNewsModal(); }
        });

        document.getElementById('newsModal').addEventListener('click', function(e) {
            if (e.target === this) { closeNewsModal(); }
        });
    </script>
</body>
</html>
